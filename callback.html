
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Clock-in Callback</title>
  <script type="module">
    import { sendToDiscord } from './webhook.js';

    async function run() {
      const params = new URLSearchParams(window.location.hash.substring(1));
      const token = params.get("access_token");
      const state = params.get("state"); // Discord user_id ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å login.html

      if (!token) {
        document.body.innerHTML = "<h2>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Discord ‡πÑ‡∏î‡πâ</h2>";
        return;
      }

      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Discord API
      const userRes = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const userData = await userRes.json();
      const username = `${userData.username}#${userData.discriminator}`;

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏±‡∏®‡∏°‡∏µ
        const branches = [
          { name: "‡πÄ‡∏°‡∏Å‡∏≤‡∏ö‡∏≤‡∏á‡∏ô‡∏≤", lat: 13.6431, lng: 100.6794 },
          { name: "‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• 3", lat: 13.7793, lng: 100.6732 }
        ];

        let foundBranch = null;
        const distance = (a, b) => {
          const R = 6371;
          const dLat = (b.lat - a.lat) * Math.PI / 180;
          const dLng = (b.lng - a.lng) * Math.PI / 180;
          const aa = Math.sin(dLat/2)**2 + Math.cos(a.lat * Math.PI/180) * Math.cos(b.lat * Math.PI/180) * Math.sin(dLng/2)**2;
          return R * 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
        };

        for (const branch of branches) {
          if (distance({ lat, lng }, branch) <= 1.0) {
            foundBranch = branch.name;
            break;
          }
        }

        if (!foundBranch) {
          document.body.innerHTML = "<h2>‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Clock-in ‡πÑ‡∏î‡πâ</h2>";
          return;
        }

        // ‡πÄ‡∏ß‡∏•‡∏≤
        const time = new Date().toLocaleTimeString("th-TH", { hour: '2-digit', minute: '2-digit' });

        // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Discord Webhook
        await sendToDiscord({ username, branch: foundBranch, time, lat, lng });

        document.body.innerHTML = `
          <h2>‚úÖ Clock-in ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h2>
          <p>‡∏Ñ‡∏∏‡∏ì <strong>${username}</strong><br>
          ‡∏™‡∏≤‡∏Ç‡∏≤: ${foundBranch}<br>
          ‡πÄ‡∏ß‡∏•‡∏≤: ${time}<br>
          üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}</p>
        `;
      }, error => {
        document.body.innerHTML = "<h2>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS ‡πÑ‡∏î‡πâ</h2>";
      });
    }

    run();
  </script>
</head>
<body>
  <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Clock-in...</h2>
</body>
</html>
